<!-- Upload page template -->
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-6 mx-auto">
        <h2 class="mb-4">Wczytaj dane giełdowe</h2>
        
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="uploadTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv-panel" type="button" role="tab" aria-controls="csv-panel" aria-selected="true">
                            Upload pliku CSV
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="yahoo-tab" data-bs-toggle="tab" data-bs-target="#yahoo-panel" type="button" role="tab" aria-controls="yahoo-panel" aria-selected="false">
                            Pobierz z Yahoo Finance
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="uploadTabsContent">
                    <!-- CSV Upload Tab -->
                    <div class="tab-pane fade show active" id="csv-panel" role="tabpanel" aria-labelledby="csv-tab">
                        <p class="text-muted">Format pliku: CSV z kolumnami Date, Open, High, Low, Close</p>
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Wybierz plik CSV</label>
                                <input type="file" class="form-control" id="fileInput" name="file" accept=".csv,.txt">
                            </div>
                            <button type="submit" class="btn btn-primary">Wczytaj plik</button>
                        </form>
                        <div id="uploadMessage" class="mt-3"></div>
                    </div>
                    
                    <!-- Yahoo Finance Tab -->
                    <div class="tab-pane fade" id="yahoo-panel" role="tabpanel" aria-labelledby="yahoo-tab">
                        <p class="text-muted">Wprowadź symbol ticker (np. AAPL, MSFT, ^DJI)</p>
                        <form id="tickerForm">
                            <div class="mb-3">
                                <label for="tickerInput" class="form-label">Symbol ticker</label>
                                <input type="text" class="form-control" id="tickerInput" placeholder="AAPL" required>
                            </div>
                            <div class="mb-3">
                                <label for="periodSelect" class="form-label">Okres</label>
                                <select class="form-select" id="periodSelect">
                                    <option value="1mo">1 miesiąc</option>
                                    <option value="3mo">3 miesiące</option>
                                    <option value="6mo">6 miesięcy</option>
                                    <option value="1y" selected>1 rok</option>
                                    <option value="2y">2 lata</option>
                                    <option value="5y">5 lat</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-grid">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#advancedOptions" aria-expanded="false" aria-controls="advancedOptions">
                                        <i class="bi bi-gear-fill"></i> Zaawansowane opcje
                                        <i class="bi bi-chevron-down float-end"></i>
                                    </button>
                                </div>
                                
                                <div class="collapse mt-2" id="advancedOptions">
                                    <div class="card card-body bg-light">
                                        <h6 class="card-subtitle mb-3 text-muted">
                                            <i class="bi bi-sliders"></i> Konfiguracja pobierania danych
                                        </h6>
                                        
                                        <!-- Opcja: Skorygowane ceny -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="useAdjustedCheckbox">
                                                <label class="form-check-label" for="useAdjustedCheckbox">
                                                    <strong>Ceny skorygowane o dywidendy</strong>
                                                </label>
                                            </div>
                                            <small class="text-muted d-block mt-1 ms-4">
                                                <i class="bi bi-info-circle"></i> 
                                                <strong>Wyłączone (domyślne):</strong> Rzeczywiste ceny transakcyjne<br>
                                                <span class="ms-4">Wykresy identyczne jak na stronach giełdowych</span><br>
                                                <strong>Włączone:</strong> Ceny skorygowane o wypłacone dywidendy<br>
                                                <span class="ms-4">Zalecane do analizy stóp zwrotu w czasie</span>
                                            </small>
                                        </div>
                                        
                                        <!-- Miejsce na przyszłe opcje -->
                                        <!-- 
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="futureOption1">
                                                <label class="form-check-label" for="futureOption1">
                                                    <strong>Przyszła opcja 1</strong>
                                                </label>
                                            </div>
                                            <small class="text-muted d-block mt-1 ms-4">Opis opcji</small>
                                        </div>
                                        -->
                                        
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">Pobierz dane</button>
                        </form>
                        <div id="tickerMessage" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-5">
            <button id="scanButton" class="btn btn-lg btn-primary" disabled>
                Skanuj formacje świecowe
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('fileInput');
    formData.append('file', fileInput.files[0]);
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();
        
        const messageDiv = document.getElementById('uploadMessage');
        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">✓ ' + data.message + '</div>';
            document.getElementById('scanButton').disabled = false;
        } else {
            messageDiv.innerHTML = '<div class="alert alert-danger">✗ ' + data.error + '</div>';
        }
    } catch (error) {
        document.getElementById('uploadMessage').innerHTML = 
            '<div class="alert alert-danger">Błąd: ' + error.message + '</div>';
    }
});

document.getElementById('tickerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const ticker = document.getElementById('tickerInput').value;
    const period = document.getElementById('periodSelect').value;
    const useAdjusted = document.getElementById('useAdjustedCheckbox').checked;
    
    try {
        const response = await fetch('/api/load-ticker', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ticker, 
                period,
                use_adjusted: useAdjusted
            })
        });
        const data = await response.json();
        
        const messageDiv = document.getElementById('tickerMessage');
        if (data.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">✓ ' + data.message + '</div>';
            document.getElementById('scanButton').disabled = false;
        } else {
            messageDiv.innerHTML = '<div class="alert alert-danger">✗ ' + data.error + '</div>';
        }
    } catch (error) {
        document.getElementById('tickerMessage').innerHTML = 
            '<div class="alert alert-danger">Błąd: ' + error.message + '</div>';
    }
});

document.getElementById('scanButton').addEventListener('click', async () => {
    document.getElementById('scanButton').innerHTML = 
        '<span class="spinner-border spinner-border-sm"></span> Skanowanie...';
    
    try {
        const response = await fetch('/api/scan', {method: 'POST'});
        const data = await response.json();
        
        if (data.success) {
            window.location.href = '/results';
        }
    } catch (error) {
        alert('Błąd skanowania: ' + error.message);
    }
});
</script>
{% endblock %}
